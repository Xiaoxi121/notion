# 高性能

## 负载均衡原理及算法详解

### 什么是负载均衡

负载均衡 指的是将用户请求分摊到不同的服务器上处理，以提高系统整体的并发处理能力以及可靠性

### 负载均衡种类

#### 服务端负载均衡

服务端负载均衡 主要应用在 **系统外部请求 和 网关层** 之间，可以使用 **软件 或者 硬件** 实现。

- 四层负载均衡 工作在 OSI 模型第四层，也就是**传输层，这一层的主要协议是 TCP/UDP**，负载均衡器在这一层能够看到数据包里的源端口地址以及目的端口地址，会基于这些信息通过一定的负载均衡算法将数据包转发到后端真实服务器。也就是说**，四层负载均衡的核心就是 IP+端口层面的负载均衡，不涉及**具体的报文内容。
- 七层负载均衡 工作在 OSI 模型第七层，也就是**应用层，这一层的主要协议是 HTTP 。**这一层的负载均衡比四层负载均衡路由网络请求的方式更加复杂，它会读取报文的数据部分（比如说我们的 HTTP 部分的报文），然后根据读取到的数据内容（如 URL、Cookie）做出负载均衡决策。**也就是说，七层负载均衡器的核心是报文内容（如 URL、Cookie）层面的负载均衡，执行第七层负载均衡的设备通常被称为 反向代理服务器 。**
- 我们通常会使用 Nginx 来做七层负载均衡，LVS(Linux Virtual Server 虚拟服务器， Linux 内核的 4 层负载均衡)来做四层负载均衡。

#### 客户端负载均衡

客户端负载均衡 **主要应用于系统内部的不同的服务之间，可以使用现成的负载均衡组件来实现**

在客户端负载均衡中，客户端会自己维护一份服务器的地址列表，发送请求之前，客户端会根据对应的负载均衡算法来选择具体某一台服务器处理请求。

### 负载均衡常见的算法

1. 随机法

   1. 两次随机法

      多增加了一次随机，多选出一个服务器。随后再根据两台服务器的负载等情况，从其中选择出一个最合适的服务器

2. 轮询法

   1. 加权轮询法
   2. 平滑的加权轮询法

3. 哈希法

   将请求的参数信息通过哈希函数转换成一个哈希值，然后根据哈希值来决定请求被哪一台服务器处理。

   1. 一致性哈希

      一致性哈希法的核心思想是将数据和节点都映射到一个哈希环上，然后根据哈希值的顺序来确定数据属于哪个节点。当服务器增加或删除时，只影响该服务器的哈希，而不会导致整个服务集群的哈希键值重新分布。

4. 最小连接法

5. 最少活跃法

6. 最快响应时间法

### 七层负载均衡怎么做

1. DNS解析

   在 DNS 服务器中为同一个主机记录配置多个 IP 地址，这些 IP 地址对应不同的服务器。当用户请求域名的时候，DNS 服务器采用轮询算法返回 IP 地址，这样就实现了轮询版负载均衡。

2. 反向代理

   客户端将请求发送到反向代理服务器，由反向代理服务器去选择目标服务器，获取数据后再返回给客户端。对外暴露的是反向代理服务器地址，隐藏了真实服务器 IP 地址。反向代理“代理”的是目标服务器，这一个过程对于客户端而言是透明的。

3. HTTP重定向

### 客户端负载均衡通常是怎么做的？

Netflix Ribbon 和 Spring Cloud Load Balancer 就是目前 Java 生态最流行的两个负载均衡组件。

1. Ribbon
   1. RandomRule：随机策略。
      RoundRobinRule（默认）：轮询策略
      WeightedResponseTimeRule：权重（根据响应时间决定权重）策略
      BestAvailableRule：最小连接数策略
      RetryRule：重试策略（按照轮询策略来获取服务，如果获取的服务实例为 null 或已经失效，则在指定的时间之内不断地进行重试来获取服务，如果超过指定时间依然没获取到服务实例则返回 null）
      AvailabilityFilteringRule：可用敏感性策略（先过滤掉非健康的服务实例，然后再选择连接数较小的服务实例）
      ZoneAvoidanceRule：区域敏感性策略（根据服务所在区域的性能和服务的可用性来选择服务实例
2. Spring Cloud Load Balancer（推荐）
   1. RandomLoadBalancer：随机策略
      RoundRobinLoadBalancer（默认）：轮询策

### 消息队列

#### 消息队列基础知识总结

1. 什么是中间件

   中间件就是一类为应用软件服务的软件，应用软件是为用户服务的，用户不会接触或者使用到中间件。

   除了消息队列之外，常见的中间件还有 RPC 框架、分布式组件、HTTP 服务器、任务调度框架、配置中心、数据库层的分库分表工具和数据迁移工具等等。

2. 消息队列优点

   1. 异步处理
   2. 削峰/限流
   3. 降低系统耦合性
   4. 其他应用场景：实现分布式事务、顺利保证、数据流处理、延时/定时处理、即时通讯

##### RPC和消息队列的区别

1. 从用途来看：RPC 主要用来解决两个服务的远程通信问题，不需要了解底层网络的通信机制。通过 RPC 可以帮助我们调用远程计算机上某个服务的方法，这个过程就像调用本地方法一样简单。消息队列主要用来降低系统耦合性、实现任务异步、有效地进行流量削峰。
2. 从通信方式来看：RPC 是双向直接网络通讯，消息队列是单向引入中间载体的网络通讯。
3. 从架构上来看：消息队列需要把消息存储起来，RPC 则没有这个要求，因为前面也说了 RPC 是双向直接网络通讯。
4. 从请求处理的时效性来看：通过 RPC 发出的调用一般会立即被处理，存放在消息队列中的消息并不一定会立即被处理。





































