# 如何准备系统设计面试？

1高性能架构设计： 熟悉系统常见性能优化手段比如引入 读写分离、缓存、负载均衡、异步 等等。

2高可用架构设计 ：CAP理论和BASE理论、通过集群来提高系统整体稳定性、超时和重试机制、应对接口级故障：降级、熔断、限流、排队。

3高扩展架构设计 ：说白了就是懂得如何拆分系统。你按照不同的思路来拆分软件系统，就会得到不同的架构。 

## **系统设计步骤？**

 Step1:问清楚系统具体要求 

你需要先理解系统设计的需求：功能性需求和非功能性需求。

- 为啥要询问清楚系统的功能性需求也就是说系统包含哪些功能呢？
- 为啥要询问清楚系统的非功能性需求或者说约束条件比如系统需要达到多少QPS呢？

 Step2:对系统进行抽象设计 

我们需要在一个 High Level 的层面对系统进行设计。你可以画出系统的抽象架构图，这个抽象架构图中包含了系统的一些组件以及这些组件之间的连接。

![image-20241024162818820](https://raw.githubusercontent.com/Xiaoxi121/xiaoxi.github.image/main/img/image-20241024162818820.png)

 Step3:考虑系统目前需要优化的点 

- 1当前系统部署在一台机器够吗？是否需要部署在多台机器然后进行负载均衡呢？
- 2数据库处理速度能否支撑业务需求？是否需要给指定字段加索引？是否需要读写分离？是否需要缓存？
- 3数据量是否大到需要分库分表？
- 4是否存在安全隐患？
- 5系统是否需要分布式文件系统？
- 6......

 Step4:优化你的系统抽象设计 



##  **技术选型** 

实现同样的功能，一般会有多种技术选择方案，比如缓存用Redis 还是 Memcached、网关用 Spring Cloud Gateway 还是Netflix Zuul2 。 很多时候，面试官在系统设计面过程中会具体到技术的选型，因而，你需要区分不同技术的优缺点。



##  **系统设计面试必知** 

###  **性能相关的指标** 

-  响应时间 

  响应时间RT(Response-time)就是用户发出请求到用户收到系统处理结果所需要的时间。

  RT是一个非常重要且直观的指标，RT数值大小直接反应了系统处理用户请求速度的快慢。

-  并发数 

  并发数可以简单理解为系统能够同时供多少人访问使用也就是说系统同时能处理的请求数量。

  并发数反应了系统的负载能力。

-  QPS 和 TPS 

  - QPS（Query Per Second） ：服务器每秒可以执行的查询次数；

  - TPS（Transaction Per Second） ：服务器每秒处理的事务数（这里的一个事务可以理解为客户发出请求到收到服务器的过程）；

  - 书中是这样描述 QPS 和 TPS 的区别的。

    QPS vs TPS：QPS 基本类似于 TPS，但是不同的是，对于一个页面的一次访问，形成一个TPS；但一次页面请求，可能产生多次对服务器的请求，服务器对这些请求，就可计入“QPS”之中。如，访问一个页面会请求服务器2次，一次访问，产生一个“T”，产生2个“Q”。

-  吞吐量 

  吞吐量指的是系统单位时间内系统处理的请求数量。

  一个系统的吞吐量与请求对系统的资源消耗等紧密关联。请求对系统资源消耗越多，系统吞吐能力越低，反之则越高。

- TPS、QPS都是吞吐量的常用量化指标。

  - QPS（TPS） = 并发数/平均响应时间(RT)
  - 并发数 = QPS * 平均响应时间(RT)

###  **系统活跃度** 

-  PV(Page View) 

  访问量, 即页面浏览量或点击量，衡量网站用户访问的网页数量；在一定统计周期内用户每打开或刷新一个页面就记录1次，多次打开或刷新同一页面则浏览量累计。UV 从网页打开的数量/刷新的次数的角度来统计的。

-  UV(Unique Visitor) 

  独立访客，统计1天内访问某站点的用户数。1天内相同访客多次访问网站，只计算为1个独立访客。UV 是从用户个体的角度来统计的。

-  DAU(Daily Active User) 

  日活跃用户数量。

-  MAU(monthly active users) 

  月活跃用户人数。

  

- 举例：某网站 DAU为 1200w， 用户日均使用时长 1 小时，RT为0.5s，求并发量和QPS。

- 平均并发量 = DAU（1200w）* 日均使用时长（1 小时，3600秒） /一天的秒数（86400）=1200w/24 = 50w

- 真实并发量（考虑到某些时间段使用人数比较少） = DAU（1200w）* 日均使用时长（1 小时，3600秒） /一天的秒数-访问量比较小的时间段假设为8小时（57600）=1200w/16 = 75w

- 峰值并发量 = 平均并发量 * 6 = 300w

- QPS = 真实并发量/RT = 75W/0.5=150w/s


###  常用性能测试工具 

 **后端常用** 

既然系统设计涉及到系统性能方面的问题，那在面试的时候，面试官就很可能会问：你是如何进行性能测试的？

推荐 4 个比较常用的性能测试工具：

1Jmeter ：Apache JMeter 是 JAVA 开发的性能测试工具。

2LoadRunner：一款商业的性能测试工具。

3Galtling ：一款基于Scala 开发的高性能服务器性能测试工具。

4ab ：全称为 Apache Bench 。Apache 旗下的一款测试工具，非常实用。

没记错的话，除了 LoadRunner 其他几款性能测试工具都是开源免费的。



 **前端常用** 

1Fiddler：抓包工具，它可以修改请求的数据，甚至可以修改服务器返回的数据，功能非常强大，是Web 调试的利器。

2HttpWatch: 可用于录制HTTP请求信息的工具。



###  常见软件的QPS 

这里给出的 QPS 仅供参考，实际项目需要进行压测来计算。

●Nginx ：一般情况下，系统的性能瓶颈基本不会是 Nginx。单机 Nginx 可以达到 30w +。

●Redis:  Redis 官方的性能测试报告：https://redis.io/topics/benchmarks  。
从报告中，我们可以得出 Redis 的单机 QPS 可以达到 8w+（CPU性能有关系，也和执行的命令也有关系比如执行 SET 命令甚至可以达到10w+QPS）。

●MySQL:  MySQL 单机的 QPS 为 大概在 4k 左右。

●Tomcat ：单机 Tomcat 的QPS 在 2w左右。这个和你的 Tomcat 配置有很大关系，举个例子Tomcat 支持的连接器有 NIO、NIO.2 和 APR。 AprEndpoint 是通过 JNI 调用 APR 本地库而实现非阻塞 I/O 的，性能更好，Tomcat 配置 APR 为 连接器的话，QPS 可以达到 3w左右。更多相关内容可以自行搜索 Tomcat 性能优化。



###  系统设计原则 

合适优于先进 > 演化优于一步到位 > 简单优于复杂



###  常见的性能优化策略 

1当前系统的SQL语句是否存在问题？

2当前系统是否需要升级硬件？

3系统是否需要缓存？

4系统架构本身是不是就有问题？

5系统是否存在死锁的地方？

6数据库索引使用是否合理？

7系统是否存在内存泄漏？（Java 的自动回收内存虽然很方便，但是，有时候代码写的不好真的会造成内存泄漏）

8系统的耗时操作进行了异步处理？

9……

 **性能优化必知法则** 

SQL优化，JVM、DB，Tomcat参数调优 > 硬件性能优化（内存升级、CPU核心数增加、机械硬盘—>固态硬盘等等）> 业务逻辑优化/缓存 > 读写分离、集群等 > 分库分表

# 秒杀系统

## 基本思路

秒杀系统主要为商品（往往是爆款商品）秒杀活动提供支持，这个秒杀活动会限制商品的个数以及秒杀持续时间。

秒杀系统的业务逻辑非常简单，一般就是下订单减库存，**难点在于我们如何保障秒杀能够顺利进行。**

- 秒杀开始的时候，会有大量用户同时参与进来，因此秒杀系统一定要满足 **高并发 和 高性能 。**
- 为了保证秒杀整个流程的顺利进行，整个秒杀系统必须要满足 **高可用 。**
- 除此之外，**由于商品的库存有限，在面对大量订单的情况下，一定不能超卖，我们还需要保证 一致性 。**

- 高并发简单来说就是能够同时处理很多用户请求。
- 高性能简单来说就是处理用户的请求速度要快。
- 高可用简单来说就是我们的系统要在趋近 100% 的时间内都能正确提供服务。

我们站在技术层面来思考一下：“设计秒杀系统的过程中需要重点关注哪些问题”。


- 参与秒杀的商品属于热点数据，**我们该如何处理热点数据？**
- 商品的库存有限，在面对大量订单的情况下，**如何解决超卖的问题？**
- 如果系统用了消息队列，**如何保证消息队列不丢失消息？**
- **如何保证秒杀系统的高可用？**
- **如何对项目进行压测？**有哪些工具？

## 高性能

### **热点数据处理**

何为热点数据？ 热点数据指的就**是某一时间段内被大量访问的数据，**比如爆款商品的数据、新闻热点。
为什么要关注热点数据？ 热点数据可能仅仅占据系统所有数据的 0.1% ，但是其访问量可能是比其他所有数据之和还要多。不重点处理热点数据，势必会给系统资源消耗带来严峻的挑战。

热点数据的分类？ 根据热点数据的特点，我们通常将其分为两类：

- **静态热点数据** ：可以**提前预测到**的热点数据比如要秒杀的商品。
- **动态热点数据 ：** 不能够提前预测到的热点数据，需要通过一些手段动态检测系统运行情况产生。

另外，处理热点数据的问题的关键就在于 我们如何找到这些热点数据（或者说热 key），然后将它们存在 jvm 内存里。
 **对于并发量非常一般的系统直接将热点数据存放进缓存比如 Redis 中就可以了**，不过像淘宝、京东这种级别的并发量，如果把某些热点数据放在 Redis 中，直接可能就将整个 Redis 集群给干掉了。

### **如何检测热点数据？**

- 我了解到的是市面上也有一些类似的中间件，**比如京东零售的 hotkey 就是一款专门用于检测热点数据的中间件，它可以毫秒级探测热点数据，毫秒级推送至服务器集群内存。**[微信公众平台 (qq.com)](https://mp.weixin.qq.com/s/xOzEj5HtCeh_ezHDPHw6Jw)
- 另外，我们平时使用 Redis 做缓存比较多，关于如何快速定位 Redis 热点数据，可以看下[如何快速定位 Redis 热 key_架构_韩亮_InfoQ精选文章](https://www.infoq.cn/article/3l3zaq4h8xpnom2glsyi)

### **如何处理热点数据？** 

**热点数据一定要放在缓存中，并且最好可以写入到 jvm 内存一份（多级缓存），**并设置个**过期时间**。需要注意写入到 jvm 的热点数据不宜过多，避免内存占用过大**，一定要设置到淘汰策略。**
为什么还要放在 jvm 内存一份？ 因为放在 jvm 内存中的数据访问速度是最快的，不存在什么网络开销。

### **静态资源处理**

秒杀页面可能涉及到很多静态资源比如商品图片、CSS、JS。秒杀开始之前以及进行中的时候，会有大量的用户点开页面，有的用户还会不断的刷新秒杀界面。如果这些界面中的静态资源全部通过服务器获取，会造成大量的带宽消耗，甚至造成秒杀还没开始服务器就崩了。
**对于这些静态资源，我们可以使用 CDN 进行处理**，这是业内目前比较成熟的解决方案。
CDN 全称是 Content Delivery Network/Content Distribution Network，**翻译过的意思是内容分发网络 。**CDN 的作用是**将静态资源分发到多个不同的地方以实现就近访问**，进而加快静态资源的访问速度，减轻服务器以及带宽的负担。
你可以将 **CDN 看作是服务上一层的特殊缓存服务，分布在全国各地，主要用来处理静态资源的请求。**
基于成本、稳定性和易用性考虑，**建议直接选择专业的云厂商（比如阿里云、腾讯云、华为云、青云）或者 CDN 厂商（比如网宿、蓝汛）提供的开箱即用的 CDN 服务。**

## 高可用

### 集群化

如果我们想要保证系统中某一个组件的高可用**，往往需要搭建集群来避免单点风险**，比如说 Nginx 集群、Kafka 集群、Redis 集群。

我们拿 Redis 来举例说明。如果我们需要保证 Redis 高可用的话，该怎么做呢？

- 你直接通过 Redis replication（异步复制） 搞个一主(master)多从(slave)来提高可用性和读吞吐量，slave 的多少取决于你的读吞吐量。
- 这样的方式有一个问题：一旦 master 宕机，slave 晋升成 master，同时需要修改应用方的主节点地址，还需要命令所有从节点去复制新的主节点，整个过程需要人工干预。
- 不过，这个问题我们可以通过 Sentinel（哨兵） 来解决。Redis Sentinel 是 Redis 官方推荐的高可用性(HA)解决方案。
- Sentinel 是 Redis 的一种运行模式 ，它主要的作用就是对 Redis 运行节点进行监控。当 master 节点出现故障的时候， Sentinel 会帮助我们实现故障转移，确保整个 Redis 系统的可用性。整个过程完全自动，不需要人工介入!
- Sentinel 也是一个 Redis 进程，只是不对外提供读写服务，通常哨兵要配置成单数。

### 限流

限流是秒杀业务最常用的一个手段，所以经常你一参加秒杀就会提示“当前人数过多，请稍后再试”。

#### 接口限流

限流是从用户访问压力的角度来考虑如何应对系统故障。

**接口限流是为了对服务端的接口接受请求的频率进行限制**，防止服务挂掉。

**接口限流的话可以直接用 Redis 来做（建议基于 Lua 脚本），也可以使用现成的流量控制组件比如 Sentinel 、Hystrix 、Resilience4J 。**

- Hystrix 是 Netflix 开源的熔断降级组件。
- **Sentinel 是阿里巴巴体提供的面向分布式服务架构的流量控制组件，经历了淘宝近 10 年双 11（11.11）购物节的所有核心场景（比如秒杀活动）的考验。**
- Sentinel 主要以 流量为切入点，提供 流量控制、熔断降级、系统自适应保护等功能来保护系统的稳定性和可用性。
- 个人比较建议使用 Sentinel ，更新维护频率更高，功能更强大，并且生态也更丰富（Sentinel 提供与 Spring Cloud、Dubbo 和 gRPC 等常用框架和库的开箱即用集成， Sentinel 未来还会对更多常用框架进行适配，并且会为 Service Mesh 提供集群流量防护的能力）。

除了直接对接口进行限流之外，我们**还可以对用户、IP进行限流，限制同一用户以及IP单位时间内可以请求接口的次数。**

#### 问题/验证码

我们可以在用户发起秒杀请求之前让其进行答题或者输入验证码。
这种方式一方面**可以避免用户请求过于集中**，另一方面**可以有效解决用户使用脚本作弊。**
回答问题/验证码这一步建议除了对答案的正确性做校验，还需要对用户的提交时间做校验，比如提交时间过短（<1s）的话，大概就是使用脚本来处理的。

#### 提前预约

**采用提前预约才能参加秒杀活动的方式过滤一批人**。并且，我们在秒杀活动开始之前，还可以对预约的这些人进行筛选，通过某些方式找出潜在的黄牛。

#### 流量削峰

对于突发的大流量**我们还可以使用消息队列进行流量削峰。**
秒杀开始之后的流量不是很大，我处理不了嘛！那我就先把这些请求放到消息队列中去。然后，咱后端服务再慢慢根据自己的能力去消费这些消息，这样就避免直接把后端服务打垮掉。
对于秒杀场景来说，用户发送秒杀请求之后先存到消息队列中，然后再慢慢去消费。
不过，如果你**已经对接口进行的限流处理的话，这里其实就没必要再上消息队列了。**

#### 降级

**降级是从系统功能优先级的角度考虑如何应对系统故障。**
服务降级指的是当服务器压力剧增的情况下，根据当前业务情况及流量对一些服务和页面有策略的降级，以此释放服务器资源以保证核心任务的正常运行。降级的核心思想就是丢车保帅，优先保证核心业务。
🌰 举个例子：**当请求量达到一个阈值的时候，我们对系统中一些非核心的功能直接关闭或者让它们功能降低**。这样的话，系统就有更多的资源留给秒杀功能了！

#### 熔断

熔断和降级是两个比较容易混淆的概念，两者的含义并不相同。降级的目的在于应对系统自身的故障，**而熔断的目的在于应对当前系统依赖的外部系统或者第三方系统的故障。**
熔断可以防止因为秒杀交易影响到其他正常服务的提供
🌰 举个例子： 秒杀功能位于服务 A 上，服务 A 上同时还有其他的一些功能比如商品管理。如果服务 A 上的商品管理接口响应非常慢的话，其他服务直接不再请求服务 A 上的商品管理这个接口，从而有效避免其他服务被拖慢甚至拖死。

### 一致性

#### 减库存方案

常见的减库存方案有：

- **下单即减库存 ：**只要用户下单了，即使不付款，我们就扣库存。

- **付款再减库存** ：当用户付款了之后，我们再减库存。不过， 这种情况可能会造成用户下订单成功，但是付款失败。

  一般情况下都是 下单减扣库存 ，像现在的购物网站比如京东都是这样来做的。

不过，我们还会对业务逻辑做进一步优化，比如说对超过一定时间不付款的订单特殊处理，释放库存。
对应到代码层面，我们应该如何保证不会超卖呢？
我们上面也说，我们一般会提前将秒杀商品的信息放到缓存中去。我们可以通过 Lua 脚本对库存进行原子操作。伪代码如下：
不过，如果 Lua 脚本运行时出错并中途结束，出错之后的命令是不会被执行的。并且，出错之前执行的命令是无法被撤销的，无法实现类似关系型数据库执行失败可以回滚的那种原子性效果。因此， 严格来说的话，通过 Lua 脚本来批量执行 Redis 命令实际也是不完全满足原子性的。如果想要让 Lua 脚本中的命令全部执行，必须保证语句语法和命令都是对的
在 Redis 中扣减库存成功后，需要将库存同步到 MySQL 。MySQL 的库存并不需要去实时进行更新，只需要库存达到最终一致性即可，即先对 Redis 的库存进行更新，然后再异步同步到 MySQL 的库存。这里的异步实现方式建议使用 MQ，由 MQ 保证消息被消费，实现最终一致性，毕竟秒杀场景本身就要引入 MQ 进行流量削峰。
使用乐观锁防超卖可以吗？
我看到很多同学的项目经历里都提到使用乐观锁来防止超卖，不知道是从哪个培训机构学来的。 其实在秒杀系统这种高并发场景下，乐观锁是不合适的。在秒杀场景中，通常会同时有大量用户请求来抢购少量库存。在这种情况下，乐观锁的冲突率会非常高，导致大量的请求更新失败，需要频繁重试，影响效率，导致数据库压力过大，甚至引发数据库性能瓶颈。
余额扣减方案
在高并发下，余额扣减也是关键。假设用户同时下了两单 a,b，这两单都同时查到用户余额为 10000，然后执行扣款，那有一个订单就相当于没付款。
如何解决呢？在并发量高情况下推荐使用悲观锁，如果并发量不高可以考虑使用乐观锁。
悲观锁可以基于 Redis 或者 ZooKeeper 实现，但一般不会这么做，因为还要考虑他们的异常情况。余额扣减场景，对于正确性要求极高！我们可以直接利用数据库自带的排他锁（X 锁），这种方案用的最多，大部分银行都是这样做的。
在 MySQL 里使用排他锁：
乐观锁建议使用版本号机制实现，同时要注意 ABA 问题。
接口幂等
通过接口幂等保证用户不重复下单和支付，接口幂等常见方案可以查看《Java面试指北》中的这篇文章：
高可用：如何保证接口幂等性？
接口幂等性是面试中常见的问题，也是日常开发过程中经常需要解决的问题。什么是幂等(idempotency)？幂等(idempotency)本身是一个数学概念，常见于抽象代数中，表示一个函数或者操作的结果不受其输入或者执行次数的影响。例如， f(n) = 1^n ，无论 n 为多少，f(n)的值永...
《Java面试指北》
对于秒杀这种场景，建议搭配状态机实现幂等。如果使用分布式锁的话， key 可以根据请求内容生成。
性能测试
上线之前压力测试是必不可少的。推荐 4 个比较常用的性能测试工具：
1
Jmeter ：Apache JMeter 是 JAVA 开发的性能测试工具。
2
LoadRunner：一款商业的性能测试工具。
3
Galtling ：一款基于 Scala 开发的高性能服务器性能测试工具。
4
ab ：全称为 Apache Bench 。Apache 旗下的一款测试工具，非常实用。
没记错的话，除了 LoadRunner 其他几款性能测试工具都是开源免费的。
总结
我简单画了一张图来总结一下上面涉及到的一些技术。
另外，上面涉及到知识点还蛮多的，如果面试官单独挑出一个来深挖还是能够问出很多问题的。
比如面试官想在消息队里上进行深挖，可能会问：
●
常见消息队列的对比
●
如何保证消息的消费顺序？
●
如何保证消息不丢失？
●
如何保证消息不重复消费？
●
如何设计一个消息队列？
●
......
再比如面试官想在 Redis 上深挖的话，可能会问：
●
Redis 常用的数据结构了解么？
●
Redis 如何保证数据不丢失？
●
Redis 内存占用过大导致响应速度变慢怎么解决？
●
缓存穿透、缓存雪崩了解么？怎么解决？
●
......
因此，要想要真正搞懂秒杀系统的设计，你还需要将其涉及到的一些技术给研究透！

















